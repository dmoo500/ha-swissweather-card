<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SwissMeteo Card Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        #console-output { background: #1e1e1e; color: #fff; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        swissmeteo-card { display: block; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>SwissMeteo Card Debug Test</h1>
    
    <div id="status">Initializing...</div>
    <div id="console-output">Watching console output...<br></div>
    
    <h2>Test Card:</h2>
    <swissmeteo-card id="test-card"></swissmeteo-card>
    
    <script>
        // Capture console output
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalInfo = console.info;
        const originalError = console.error;
        
        function addToOutput(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.innerHTML += `<span style="color: ${type === 'error' ? '#ff6b6b' : type === 'info' ? '#4ecdc4' : '#fff'}">[${timestamp}] ${message}</span><br>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = (...args) => { originalLog(...args); addToOutput('log', ...args); };
        console.info = (...args) => { originalInfo(...args); addToOutput('info', ...args); };
        console.error = (...args) => { originalError(...args); addToOutput('error', ...args); };
    </script>
    
    <script type="module">
        console.log('üöÄ Starting SwissMeteo Card debug test...');
        
        import './swissmeteo-card.js';
        
        document.getElementById('status').textContent = 'Script loaded, checking custom element...';
        
        // Multiple checks with different timeouts
        setTimeout(() => {
            console.log('‚è∞ 100ms check...');
            const element = customElements.get('swissmeteo-card');
            if (element) {
                document.getElementById('status').textContent = 'SUCCESS: Custom element found!';
                console.log('‚úÖ Element ready, setting up test card...');
                setupTestCard();
            } else {
                document.getElementById('status').textContent = 'PENDING: Element not yet registered...';
            }
        }, 100);
        
        setTimeout(() => {
            console.log('‚è∞ 500ms check...');
            const element = customElements.get('swissmeteo-card');
            if (element && document.getElementById('status').textContent.includes('PENDING')) {
                document.getElementById('status').textContent = 'SUCCESS: Custom element found (delayed)!';
                setupTestCard();
            }
        }, 500);
        
        setTimeout(() => {
            console.log('‚è∞ 1000ms final check...');
            const element = customElements.get('swissmeteo-card');
            if (!element) {
                document.getElementById('status').textContent = 'FAILED: Custom element never registered!';
                console.error('‚ùå Final check failed - element not registered');
            }
        }, 1000);
        
        function setupTestCard() {
            const card = document.getElementById('test-card');
            
            // Mock minimal data
            card.hass = {
                states: {
                    'weather.test': {
                        state: 'sunny',
                        attributes: {
                            temperature: 22,
                            humidity: 65,
                            pressure: 1013,
                            wind_speed: 15,
                            wind_bearing: 225
                        }
                    }
                }
            };
            
            try {
                card.setConfig({
                    entity: 'weather.test',
                    location: 'Debug Test Location'
                });
                console.log('‚úÖ Test card configured successfully!');
            } catch (error) {
                console.error('‚ùå Error configuring test card:', error);
            }
        }
        
        // Listen for custom element definition
        customElements.whenDefined('swissmeteo-card').then(() => {
            console.log('üéâ customElements.whenDefined() resolved!');
            if (document.getElementById('status').textContent.includes('PENDING')) {
                document.getElementById('status').textContent = 'SUCCESS: Custom element defined via whenDefined!';
                setupTestCard();
            }
        }).catch(error => {
            console.error('‚ùå customElements.whenDefined() error:', error);
        });
    </script>
</body>
</html>
